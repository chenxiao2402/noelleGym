#!/bin/bash -e

# Get the inputs
if test $# -lt 1 ; then
  echo "USAGE: `basename $0` JOBNAME" ;
  exit 1;
fi

machineName=$1 ;
jobDir=$2 ;
jobFile=$3 ;
jobParams=$4 ;
outputFile=$5 ;

if [[ ${machineName} == "default" ]] ; then
    requirements='(Machine != "fix.cs.northwestern.edu") && (Machine != "allagash.cs.northwestern.edu") && (Machine != "piraat.cs.northwestern.edu")' ;
    wholeMachineJob=false;
else
    requirements="(Machine == \"${machineName}.cs.northwestern.edu\")" ;
    wholeMachineJob=true;
fi


jobName="`echo ${jobFile} | tr -d '.sh'`_`echo ${jobParams} | tr -s ' ' '_' | tr -d "'"`" ;

# Generate executable file $jobName.con ;
awk -v repoDir="`pwd`" -v myUsername="`whoami`" -v wholeMachineJob="$wholeMachineJob" -v requirements="$requirements" -v jobDir="$jobDir" -v jobFile="$jobFile" -v jobParams="$jobParams" -v jobName="$jobName" '{
    if ($1 == "RepoPath"){
      printf("%s = %s\n", $1, repoDir);

    } else if ($1 == "Notify_User"){
      printf("%s = %s@eecs.northwestern.edu\n", $1, myUsername);

    } else if ($1 == "+IsWholeMachineJob"){
      printf("%s = %s\n", $1, wholeMachineJob);

    } else if ($1 == "Requirements"){
      printf("%s = %s\n", $1, requirements);

    } else if ($1 == "JobDir"){
      printf("%s = %s\n", $1, jobDir);

    } else if ($1 == "JobFile"){
      printf("%s = %s\n", $1, jobFile);

    } else if ($1 == "JobParams"){
      printf("%s = %s\n", $1, jobParams);

    } else if ($1 == "JobName") {
      printf("%s = %s\n", $1, jobName);

    } else {
      print ;
    }
  }' scripts/condor/submit_condor.con > ${jobName}.con ;


# submit condor job
echo "Submit Condor Job: ${jobName}" >> $outputFile 2>&1;
condor_submit ${jobName}.con >> $outputFile 2>&1;
echo "" >> $outputFile 2>&1;

logDir="`pwd`/log/condor" ;
logFile="${logDir}/${jobName}.log" ;
echo $logFile ;
